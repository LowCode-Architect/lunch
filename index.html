<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#212121">
  <link rel="apple-touch-icon" href="icon.png">

  <!-- Open Graph -->
  <meta property="og:type"        content="website">
  <meta property="og:title"       content="Lunch Roulette">
  <meta property="og:description" content="룰렛으로 간편하게 오늘의 점심을 정해보세요!">
  <meta property="og:image"
        content="https://lowcode-architect.github.io/lunch/og_image.png">
  <meta property="og:url"
        content="https://lowcode-architect.github.io/lunch/">

  <!-- Twitter -->
  <meta name="twitter:card"        content="summary_large_image">
  <meta name="twitter:title"       content="Lunch Roulette">
  <meta name="twitter:description" content="룰렛으로 간편하게 오늘의 점심을 정해보세요!">
  <meta name="twitter:image"
        content="https://lowcode-architect.github.io/lunch/og_image.png">

  <title>점심메뉴 룰렛</title>

  <!-- GSAP & Confetti -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{--mx:480px;--accent:#212121;--danger:#e53935}
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{display:flex;flex-direction:column;align-items:center;gap:16px;
         min-height:100vh;padding:24px 12px;background:#fafafa;
         font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif}

    /* 입력 */
    #addForm{display:flex;gap:8px;width:100%;max-width:var(--mx)}
    #dishInput{flex:1;padding:12px;border:1px solid #ccc;border-radius:8px;font-size:1rem}
    #addBtn{padding:12px 20px;border:none;border-radius:8px;background:var(--accent);
            color:#fff;font-weight:600;cursor:pointer}

    /* 룰렛 */
    #wrapper{position:relative;width:92vw;max-width:var(--mx)}
    canvas#wheel{width:100%;aspect-ratio:1/1;border-radius:50%;background:#fff;
                 filter:drop-shadow(0 6px 10px rgba(0,0,0,.12))}
    #pointer{--pw:clamp(14px,4vw,20px);--ph:calc(var(--pw)*1.4);
             position:absolute;left:50%;top:calc(-0.38*var(--ph));
             transform:translateX(-50%);width:0;height:0;
             border-left:var(--pw) solid transparent;border-right:var(--pw) solid transparent;
             border-top:var(--ph) solid #c0392b;
             filter:drop-shadow(0 2px 4px rgba(0,0,0,.4));pointer-events:none;z-index:10}

    /* 버튼 */
    #spinBtn{padding:14px 0;width:100%;max-width:var(--mx);font-size:1.1rem;font-weight:700;
             border:none;border-radius:12px;background:#000;color:#fff;cursor:pointer}
    #spinBtn:disabled{opacity:.4}

    /* 목록 */
    details{width:100%;max-width:var(--mx)}
    summary{cursor:pointer;text-align:center;padding:6px;color:#555;font-size:.95rem}
    ul#list{list-style:none;padding:0;margin:0}
    ul#list li{display:flex;justify-content:space-between;align-items:center;
               margin:4px 0;padding:10px;border:1px solid #ddd;border-radius:8px;background:#fff}
    ul#list li span{flex:1 1 auto;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .iconBtn{border:none;background:none;font-size:1.2rem;cursor:pointer;padding:6px}
    .delete{color:var(--danger)}.edit{color:#3949ab}

    /* 모달 */
    #modal{position:fixed;inset:0;background:rgba(0,0,0,.45);
           display:flex;align-items:center;justify-content:center;
           opacity:0;visibility:hidden;transition:.25s}
    #modal.show{opacity:1;visibility:visible}
    #modal .box{background:#fff;padding:28px 22px;border-radius:14px;text-align:center;
                max-width:80vw;animation:pop .35s cubic-bezier(.4,1.4,.6,1)}
    #closeBtn{margin-top:20px;padding:10px 24px;border:none;border-radius:10px;
              background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    @keyframes pop{0%{transform:scale(.5);opacity:.2}100%{transform:scale(1);opacity:1}}
  </style>
</head>
<body>

<form id="addForm">
  <input id="dishInput" type="text" placeholder="메뉴 이름 입력" autocomplete="off">
  <button id="addBtn" type="submit">추가</button>
</form>

<div id="wrapper">
  <canvas id="wheel"></canvas>
  <div id="pointer"></div>
</div>
<button id="spinBtn">돌려!</button>

<details>
  <summary>현재 메뉴 관리 ▾</summary>
  <ul id="list"></ul>
</details>

<!-- 결과 모달 -->
<div id="modal">
  <div class="box">
    <h2 id="resultText" style="margin-bottom:12px;font-size:1.25rem"></h2>
    <button id="closeBtn">닫기</button>
  </div>
</div>

<script>
/* ─── Persistent Data ─── */
const KEY='lunchRouletteDishes';
let dishes=JSON.parse(localStorage.getItem(KEY)||
  '["치킨","샌드위치","샐러드","김치찌개","된장찌개","비빔밥","불고기","라면"]');

/* ─── Canvas Setup ─── */
const cvs=document.getElementById('wheel'),ctx=cvs.getContext('2d');
function fitCanvas(){
  const size=Math.min(document.getElementById('wrapper').clientWidth,480),
        dpr=window.devicePixelRatio||1;
  cvs.width=cvs.height=size*dpr; ctx.setTransform(dpr,0,0,dpr,0,0);
  drawWheel();
}
window.addEventListener('resize',fitCanvas); fitCanvas();

/* ─── Draw Roulette ─── */
const pointerDeg=270;
function drawWheel(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const R=cvs.width/2, slice=360/dishes.length;
  dishes.forEach((dish,i)=>{
    const st=i*slice*Math.PI/180,ed=(i+1)*slice*Math.PI/180,mid=(st+ed)/2;
    ctx.beginPath();ctx.moveTo(R,R);ctx.arc(R,R,R,st,ed);ctx.closePath();
    ctx.fillStyle=`hsl(${i*360/dishes.length},60%,75%)`;
    ctx.fill();ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
    const x=R+Math.cos(mid)*R*0.6, y=R+Math.sin(mid)*R*0.6;
    ctx.save();ctx.translate(x,y);ctx.rotate(mid+Math.PI/2);
    ctx.font=`bold ${Math.max(R*0.1,14)}px sans-serif`;
    ctx.fillStyle='#000';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(dish,0,0);ctx.restore();
  });
  renderList();
  localStorage.setItem(KEY,JSON.stringify(dishes));
}

/* ─── Menu List ─── */
function renderList(){
  const ul=document.getElementById('list'); ul.innerHTML='';
  dishes.forEach((dish,i)=>{
    const li=document.createElement('li');
    li.innerHTML=`<span>${dish}</span>
      <button class="iconBtn edit">✏️</button>
      <button class="iconBtn delete">❌</button>`;
    li.querySelector('.edit').onclick=()=>{
      const v=prompt('메뉴 수정',dish);if(v&&v.trim()){dishes[i]=v.trim();drawWheel();}
    };
    li.querySelector('.delete').onclick=()=>{
      if(confirm(`"${dish}" 삭제?`)){dishes.splice(i,1);drawWheel();}
    };
    ul.appendChild(li);
  });
}

/* ─── Canvas Tap to delete ─── */
cvs.addEventListener('click',e=>{
  const R=cvs.width/2, rect=cvs.getBoundingClientRect(), scale=cvs.width/rect.width,
        x=(e.clientX-rect.left)*scale, y=(e.clientY-rect.top)*scale;
  if(Math.hypot(x-R,y-R)>R) return;
  const idx=Math.floor(((Math.atan2(y-R,x-R)*180/Math.PI+360)%360)/(360/dishes.length));
  if(confirm(`"${dishes[idx]}" 삭제?`)){dishes.splice(idx,1);drawWheel();}
});

/* ─── Modal & Confetti ─── */
const modal=document.getElementById('modal'), result=document.getElementById('resultText'),
      closeBtn=document.getElementById('closeBtn');
function showResult(text){
  result.textContent=`오늘의 점심은 “${text}” 입니다!`;
  modal.classList.add('show');
  const end=Date.now()+1500;
  (function frame(){
    confetti({particleCount:16,startVelocity:28,spread:60,origin:{y:.25}});
    if(Date.now()<end) requestAnimationFrame(frame);
  })();
}
function hide(){modal.classList.remove('show');}
closeBtn.onclick=hide; modal.addEventListener('click',e=>{if(e.target===modal)hide();});
window.addEventListener('keyup',e=>{if(e.key==='Escape')hide();});

/* ─── Spin ─── */
const spinBtn=document.getElementById('spinBtn');
spinBtn.onclick=()=>{
  if(dishes.length<2){alert('메뉴를 두 개 이상 입력하세요!');return;}
  spinBtn.disabled=true;
  gsap.to(cvs,{rotation:`+=${360*4+Math.random()*360}`,duration:3.5,ease:'power4.out',
    onComplete:()=>{
      const slice=360/dishes.length, final=gsap.getProperty(cvs,'rotation'),
            idx=Math.floor((((pointerDeg-final)%360)+360)%360/slice);
      spinBtn.disabled=false;
      showResult(dishes[idx]);
    }});
};

/* ─── Add ─── */
document.getElementById('addForm').onsubmit=e=>{
  e.preventDefault(); const v=dishInput.value.trim();
  if(v){dishes.push(v); dishInput.value=''; drawWheel();}
};

/* ─── Service Worker ─── */
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js'));
}
</script>
</body>
</html>
